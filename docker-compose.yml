services:
  nginx:
    image: nginx:1.27-alpine
    container_name: funasr-nginx
    ports:
      - "${NGINX_PORT:-17003}:80"
    volumes:
      - ./funasr.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - funasr-api
    restart: unless-stopped
    networks:
      - funasr-net

  funasr-api:
    image: quantatrisk/funasr-api:gpu-latest
    container_name: funasr-api
    expose:
      - "8000"
    volumes:
      - ./temp:/app/temp
      - ./logs:/app/logs
      - ./models/modelscope:/root/.cache/modelscope
      - ./models/huggingface:/root/.cache/huggingface
    environment:
      API_KEY: ${API_KEY:-}
      ENABLED_MODELS: ${ENABLED_MODELS:-auto}
      MODELSCOPE_PATH: /root/.cache/modelscope/hub/models
      HF_HOME: /root/.cache/huggingface
      HF_HUB_OFFLINE: ${HF_HUB_OFFLINE:-}
      HF_DATASETS_OFFLINE: ${HF_DATASETS_OFFLINE:-}
      TRANSFORMERS_OFFLINE: ${TRANSFORMERS_OFFLINE:-}
    restart: unless-stopped
    networks:
      - funasr-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

networks:
  funasr-net:
    name: funasr-net
